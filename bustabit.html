<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Bustabit Buzzer</title>
  <style>
    body { font-family: Arial, sans-serif; text-align: center; padding-top: 40px; }
    .hidden { display: none; }
    .btn { padding: 10px 20px; font-size: 16px; cursor: pointer; border-radius: 8px; border: none; margin: 5px; }
    #buzzer { width: 200px; height: 200px; border-radius: 50%; background-color: red; margin: 40px auto; cursor: pointer; transition: background-color 0.2s ease; }
    table { margin: 0 auto; border-collapse: collapse; width: 70%; }
    th, td { padding: 12px; border: 1px solid #555; font-size: 18px; }
    th { background: #eee; }
    #majorityLight { width: 50px; height: 50px; border-radius: 50%; display: inline-block; background-color: red; margin-left: 10px; vertical-align: middle; }
    #majorityLabel { font-size: 18px; font-weight: bold; vertical-align: middle; }
  </style>
</head>
<body>
  <!-- Home Screen -->
  <div id="home">
    <h1>The Hoes et al. Play Bustabit and Lose Everything</h1>
    <button id="guestBtn" class="btn">Hoe</button>
    <button id="hostBtn" class="btn">Ben</button>
  </div>

  <!-- Guest Name Entry -->
  <div id="guestNameScreen" class="hidden">
    <h2>Enter Your Name</h2>
    <input type="text" id="guestNameInput" placeholder="Your name" />
    <br/><br/>
    <button id="submitNameBtn" class="btn">Submit</button>
  </div>

  <!-- Buzzer Screen -->
  <div id="buzzerScreen" class="hidden">
    <h2 id="welcomeText"></h2>
    <div id="buzzer"></div>
  </div>

  <!-- Host Screen -->
  <div id="hostScreen" class="hidden">
    <h2>Pull Out Indicator:<span id="majorityLight"></span></h2>
    <button id="unlockBtn" class="btn">Unlock All Buzzers</button>
    <button id="resetBustsBtn" class="btn">Reset Bust Counters</button>
    <h3>Total Guests: <span id="guestCount">0</span></h3>
    <table>
      <thead>
        <tr>
          <th>Hoe</th>
          <th>Pressed?</th>
          <th>Busts</th>
        </tr>
      </thead>
      <tbody id="scoreboardBody"></tbody>
    </table>
    <br/>
    <button id="removeAllBtn" class="btn">Remove All Guests</button>
  </div>

  <!-- Firebase modular SDK -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.11.1/firebase-app.js";
    import { getDatabase, ref, push, update, onValue, get, remove } from "https://www.gstatic.com/firebasejs/10.11.1/firebase-database.js";

    const firebaseConfig = {
      apiKey: "AIzaSyAzoxOKLSQHRH0Eo6pC3s9xoPeKklfp4YM",
      authDomain: "bustabit-e3659.firebaseapp.com",
      databaseURL: "https://bustabit-e3659-default-rtdb.firebaseio.com/",
      projectId: "bustabit-e3659",
      storageBucket: "bustabit-e3659.appspot.com",
      messagingSenderId: "892180950202",
      appId: "1:892180950202:web:90e44a5ac82bb11761a683",
      measurementId: "G-65669MB3K7"
    };

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);

    const home = document.getElementById('home');
    const guestBtn = document.getElementById('guestBtn');
    const hostBtn = document.getElementById('hostBtn');
    const guestNameScreen = document.getElementById('guestNameScreen');
    const submitNameBtn = document.getElementById('submitNameBtn');
    const guestNameInput = document.getElementById('guestNameInput');
    const buzzerScreen = document.getElementById('buzzerScreen');
    const welcomeText = document.getElementById('welcomeText');
    const buzzer = document.getElementById('buzzer');
    const hostScreen = document.getElementById('hostScreen');
    const scoreboardBody = document.getElementById('scoreboardBody');
    const guestCount = document.getElementById('guestCount');
    const unlockBtn = document.getElementById('unlockBtn');
    const removeAllBtn = document.getElementById('removeAllBtn');
    const resetBustsBtn = document.getElementById('resetBustsBtn');
    const majorityLight = document.getElementById('majorityLight');

    let currentGuestKey = null;

    guestBtn.onclick = () => {
      home.classList.add('hidden');
      guestNameScreen.classList.remove('hidden');
    };

    hostBtn.onclick = () => {
      home.classList.add('hidden');
      hostScreen.classList.remove('hidden');
    };

    submitNameBtn.onclick = async () => {
      const name = guestNameInput.value.trim();
      if (!name) return;

      const newEntry = await push(ref(db, 'guests'), { name, pressed: false, locked: false, busts: 0 });
      currentGuestKey = newEntry.key;

      guestNameScreen.classList.add('hidden');
      buzzerScreen.classList.remove('hidden');
      welcomeText.textContent = `Press the buzzer to pull out!`;
      buzzer.style.backgroundColor = 'red';
    };

    buzzer.onclick = async () => {
      if (!currentGuestKey) return;
      const guestRef = ref(db, `guests/${currentGuestKey}`);
      const snap = await get(guestRef);
      const data = snap.val();
      if (!data.pressed && !data.locked) {
        await update(guestRef, { pressed: true, locked: true });
        buzzer.style.backgroundColor = 'green';
      }
    };

    unlockBtn.onclick = async () => {
      const guestsSnap = await get(ref(db, 'guests'));
      guestsSnap.forEach(child => {
        if (child.val().pressed) {
          update(ref(db, `guests/${child.key}`), { locked: false, pressed: false });
        }
      });
    };

    resetBustsBtn.onclick = async () => {
      const guestsSnap = await get(ref(db, 'guests'));
      guestsSnap.forEach(child => {
        update(ref(db, `guests/${child.key}`), { busts: 0 });
      });
    };

    removeAllBtn.onclick = async () => {
      await remove(ref(db, 'guests'));
    };

    onValue(ref(db, 'guests'), snapshot => {
      scoreboardBody.innerHTML = '';
      let count = 0;
      let pressedCount = 0;
      let guestsData = [];

      snapshot.forEach(child => {
        const data = child.val();
        guestsData.push({ key: child.key, data });
        count++;
        if (data.pressed) pressedCount++;
      });

      guestsData.sort((a, b) => b.data.busts - a.data.busts);

      guestsData.forEach(item => {
        const data = item.data;
        const row = document.createElement('tr');
        row.innerHTML = `<td>${data.name}</td><td>${data.pressed ? 'Yes' : 'No'}</td>
          <td>
            <button class='btn' onclick='adjustBust("${item.key}", -1)'>-</button>
            <span id='bust-${item.key}'>${data.busts}</span>
            <button class='btn' onclick='adjustBust("${item.key}", 1)'>+</button>
          </td>`;
        scoreboardBody.appendChild(row);
      });

      guestCount.textContent = count;

      if (count > 0 && pressedCount / count > 0.5) {
        majorityLight.style.backgroundColor = 'green';
      } else {
        majorityLight.style.backgroundColor = 'red';
      }
    });

    window.adjustBust = async (key, delta) => {
      const guestRef = ref(db, `guests/${key}`);
      const snap = await get(guestRef);
      const current = snap.val().busts || 0;
      const newCount = Math.max(0, current + delta);
      await update(guestRef, { busts: newCount });
    };
  </script>
</body>
</html>
